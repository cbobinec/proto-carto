<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />

    <style>
      html {
        max-width: 120ch;
        padding: 3em 1em;
        margin: auto;
        line-height: 1.75;
        font-size: 1.25em;
      }

      h1, h2, h3, h4, h5, h6 {
        margin: 1em 0 1em;
      }

      p, ul, ol {
        margin-bottom: 2em;
        color: #1d1d1d;
        font-family: sans-serif;
      }

      #menu {
        padding: 10px;
        font-family: 'Open Sans', sans-serif;
      }
    </style>
  </head>

  <body>
    <div>
      <h1>Bac à sable Maplibre : fonds de carte</h1>
      <div>
        - <a href="https://docs.mapbox.com/mapbox-gl-js/example/setstyle/">Exemple doc maplibre</a> 
        - <a href="https://static.geotribu.fr/articles/2021/2021-02-23_carte_ligne_libre/#2-mobiliser-des-fonds-de-cartes-vectoriels-libres">Des fonds de carte où piocher</a></h2>
        - <a href="https://geoservices.ign.fr/documentation/services/api-et-services-ogc/tuiles-vectorielles-tmswmts/styles">Doc IGN</a>
        <div id="menu"></div>
      <div class="map" style="width: 100%; height: 400px;"></div>
    </div>

    <script>
      const liste_fonds = {
        ign_standard: {
          libelle: 'IGN standard',
          url: 'https://wxs.ign.fr/essentiels/static/vectorTiles/styles/PLAN.IGN/standard.json',
          correctif_ign: true,
        },
        ign_attenue: {
          libelle: 'IGN attenué',
          url: 'https://wxs.ign.fr/static/vectorTiles/styles/PLAN.IGN/essentiels/attenue.json',
          correctif_ign: true,
        },
        ign_gris: {
          libelle: 'IGN gris',
          url: 'https://wxs.ign.fr/static/vectorTiles/styles/PLAN.IGN/essentiels/gris.json',
          correctif_ign: true,
        },     
        ign_sans_toponyme: {
          libelle: 'IGN sans toponyme',
          url: 'https://wxs.ign.fr/static/vectorTiles/styles/PLAN.IGN/essentiels/sans_toponymes.json',
          correctif_ign: true,
        },        
        etalab_bright: {
          libelle: 'Etatlab OSM Bright',
          url: 'https://openmaptiles.geo.data.gouv.fr/styles/osm-bright/style.json'
        },
      }

      // CHANGEMENT DE FONDS
      // Création des boutons
      const menu = document.getElementById("menu");
      const makeInput = (obj) => `
      ${Object.entries(obj)        
        .map(([key, value]) => `<button type="button" id="${key}">${value.libelle}</button>`)
        .join("\n")}
      `;
      menu.innerHTML = makeInput(liste_fonds);
      // CHANGEMENT DE FONDS
      
      // Par défaut on charge le premier fond
      fetch(liste_fonds["ign_gris"]["url"])
        .catch(err => {
            console.log('Le `fetch()` du style à échoué');
        })
        .then((res) => res.json())
        .then((style) => {
          if (liste_fonds["ign_standard"]["correctif_ign"]) {
            // Patch tms scheme to xyz to make it compatible for Maplibre GL JS / Mapbox GL JS
            // https://guides.etalab.gouv.fr/apis-geo/3-tuiles-vecteur.html#l-alternative-des-tuiles-vecteur-de-l-ign
            style.sources.plan_ign.scheme = "xyz";
            style.sources.plan_ign.attribution = "© IGN";
          }

          const map = new maplibregl.Map({
          style: style,
          center: [2.35, 48.85],
          zoom: 11,
          container: document.querySelector(".map"),
          });

            map.on('load', () => {
                // On désactive le compass
                map.addControl(new maplibregl.NavigationControl({
                  showCompass: false
                }));
                // Mode plein écran
                map.addControl(new maplibregl.FullscreenControl());
                // Geolocalisation
                map.addControl(new maplibregl.GeolocateControl());

                map.addSource('insee200m', {
                type: 'vector',
                tiles: [`https://insee-proto-tiles.netlify.app/filosofi-2017-200m/{z}/{x}/{y}.pbf`],
                minzoom: 10,
                maxzoom: 10,
                });

                const layerOptions = {
                id: 'insee_carroyage200m_fill',
                source: 'insee200m',
                type: 'fill',
                'source-layer': 'custom',
                paint: {
                    'fill-opacity': 0.5,
                    'fill-color': [
                    'step', // function
                    ['get', 'Men'], // value
                    '#FFFFCC',
                    10, '#FFFFCC',
                    20, '#FFE6B4',
                    50, '#FFC696',
                    300, '#FFA176',
                    1300, '#FF7755',
                    3200, '#E05544',
                    6300, '#cc3333',
                    12000, '#990000',
                    23600, '#660000',
                    ],
                },
                };

                map.addLayer(layerOptions);
            });

            // Rajout évenement sur les boutons
            const buttons = menu.getElementsByTagName('button');
 
            for (const button of buttons) {
              button.onclick = (layer) => {
                idFond = layer.target.id;
                url_style = liste_fonds[idFond]["url"];

                fetch(url_style)
                  .catch(err => {
                      console.log('Le `fetch()` du style à échoué');
                  })
                  .then((res) => res.json())
                  .then((style) => {
                    if (liste_fonds[idFond]["correctif_ign"]) {
                      // Patch tms scheme to xyz to make it compatible for Maplibre GL JS / Mapbox GL JS
                      // https://guides.etalab.gouv.fr/apis-geo/3-tuiles-vecteur.html#l-alternative-des-tuiles-vecteur-de-l-ign
                      style.sources.plan_ign.scheme = "xyz";
                      style.sources.plan_ign.attribution = "© IGN";
                    }
                    map.setStyle(style);
                  })
                }
            }
        });
    </script>
  </body>
</html>